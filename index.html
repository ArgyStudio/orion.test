<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Empezar a Jugar</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <main class="card" role="dialog" aria-labelledby="heroTitle age-title" aria-describedby="age-desc">
    <!-- TITULO PRINCIPAL DIN츼MICO (muestra nombre sacado de la 칰ltima parte de la URL) -->
    <h2 id="heroTitle" class="hero-title" aria-live="polite">춰Te saluda Wonbet<span id="username">Jugador</span>!</h2>

    <!-- Subtitulo / T칤tulo de la card -->

    <p id="age-desc" class="lead">Sos mayor de <strong>18+</strong> a침os?</p>

    <!-- BLOQUE: JUGAR -->
    <div class="cta-wrap" aria-label="Acci칩n jugar">
      <a href="#" class="btn" id="playBtn" role="button" aria-pressed="false">JUGAR</a>
    </div>

    <div class="desc" aria-hidden="false">
      <p><strong>Haz click aqui para Jugar</strong></p>
    </div>

    <div class="notice" aria-hidden="false">
      <div class="box">
        <p class="title">游꿣 JUGAR</p>
        <div class="leftbar">
          <p class="content">
            Si ya tenes Usuario pod칠s hacer click en este bot칩n para <strong>empezar a Jugar.</strong><br>
            <span style="display:inline-block; margin-top:6px; font-size:12px; opacity:0.85;">
              No compartas tus datos con nadie.
            </span>
          </p>
        </div>
      </div>
    </div>

    <!-- separador -->
    <hr class="sep">

    <!-- BLOQUE ADICIONAL: CAJA -->
    <div class="cta-wrap" aria-label="Acci칩n caja" style="margin-top:6px;">
      <a href="#" class="btn" id="cajaBtn" role="button" aria-pressed="false">CAJA</a>
    </div>

    <div class="desc" aria-hidden="false" style="margin-top:10px;">
      <p style="font-weight:700;">
        Hace click ac치 para <strong>cargas y retiros</strong>
      </p>
    </div>

    <div class="notice" aria-hidden="false" style="margin-top:10px;">
      <div class="box">
        <p class="title">游낂 CAJA</p>
        <div class="leftbar">
          <p class="content">
            Para comunicarte con un cajero y hacer una <strong>recarga/retiro</strong> o cualquier otro tipo de duda sobre tu usuario, esta es la opci칩n a elegir.
          </p>
        </div>
      </div>
    </div>

  </main>

<script>

  let name;

/* ---------- Extrae token (preferencia: query) y lo formatea ---------- */
(function () {
  // intenta primero sacar lo que viene despu칠s del "?"
  const search = window.location.search || '';
  let rawResult = '';

  if (search.length > 1) {
    // quitamos el "?" y cualquier hash
    const raw = search.slice(1).split('#')[0];

    if (raw.includes('=')) {
      // caso standard key=value: tomamos el primer par치metro disponible
      const params = new URLSearchParams(raw);
      const firstKey = Array.from(params.keys())[0];
      const firstValue = params.get(firstKey);
      rawResult = (firstValue !== null && firstValue !== '') ? firstValue : firstKey;
    } else {
      // caso token suelto: ?Rmati1aho
      rawResult = raw.split('&')[0];
    }
  } else {
    // si no hay query, usamos el 칰ltimo segmento del pathname
    rawResult = window.location.pathname.split('/').filter(Boolean).pop() || '';
  }

  // fallback si qued칩 vac칤o
  if (!rawResult) rawResult = 'Jugador';

  // decodificar y limpiar: + -> espacio, reemplazar -/_ por espacios, trim
  const decoded = decodeURIComponent(rawResult.replace(/\+/g, ' ')).replace(/[-_]+/g, ' ').trim();

  // capitalizar cada palabra y asignar a la variable `name` (ya declarada arriba)
  name = decoded
    .split(/\s+/)
    .map(s => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase())
    .join(' ');

  // setea en el span si existe
  const el = document.getElementById('username');
  if (el) el.textContent = name || 'Jugador';
})();



  async function  postBack(url, payload) {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    let text = await res.text();
      console.log("Respuesta del servidor:", text);
      if (!res.ok){
        console.error("PostBack HTTP error", res.status, text);

      }

      try {
        return JSON.parse(text);
      } catch (error) {
        return text; // no es JSON, devuelvo el texto tal cual
      }

  }

  /* ---------- Handlers de botones y accesibilidad ---------- */
  document.getElementById('playBtn').addEventListener('click', function (e) {
    
    window.open("https://wonbet.lat/", "_blank", "noopener,noreferrer");
    
    // ejemplo: redirigir o ejecutar funci칩n real
    // e.preventDefault(); // descoment치 si us치s solo demo
    console.log('JUGAR -> clicked');
    // window.location.href = '/jugar'; // ejemplo real
  });

document.getElementById('cajaBtn').addEventListener('click', async function (e) {
  console.log('CAJA -> clicked');
  const Usuario = name;
  console.log(`Usuario: ${Usuario}`);

  const URL = "https://xneli80uz8.execute-api.us-east-2.amazonaws.com/default/orion-l";

  if (!Usuario || Usuario.trim() === "") {
    window.alert("丘멆잺Error: No se encontro tu usuario\n 游띔Por favor ingresar desde el link que se te envio antes");
    return; // <- importante para no seguir
  }

  try {
    const payload = { Usuario };
    // await ahora ES v치lido porque la funci칩n es async
    const serverResp = await postBack(URL, payload);
    console.log("Datos enviados al servidor");
    console.log(payload);
    console.log('Respuesta del servidor:', serverResp);

    // Ajust치 el nombre seg칰n lo que devuelva tu backend: lineaCaja vs linea
    const linea = (serverResp.lineaCaja && serverResp.lineaCaja.trim() !== "") 
      ? serverResp.lineaCaja.trim() 
      : (serverResp.linea && serverResp.linea.trim() !== "" ? serverResp.linea.trim() : null);

    if (!linea) {
      alert('No se recibi칩 n칰mero de caja del servidor.');
      return;
    }

    // opcional: sanitizar (quitar todo menos d칤gitos)
    const phone = linea.replace(/\D/g, '');
    const message = `Hola, este es mi usuario: ${Usuario}, y quiero...`;

    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, "_blank", "noopener,noreferrer");
  } catch (err) {
    console.error('Error en comunicaci칩n con el servidor:', err);
    alert('Ocurri칩 un error al contactarnos. Revisa la consola para m치s detalles.');
  }
});


  // teclas r치pidas: Enter dispara JUGAR
  window.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      document.getElementById('playBtn').click();
    } else if (e.key === 'Escape') {
      // opcional: podr칤as cerrar el modal si lo quer칠s implementar
    }
  });
</script>

</body>
</html>
